---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Working with multiple datasets

Let us learn about working with multiple datasets using the heart attack encounters dataset. 

::::: {.rBlock}
###### R {-}
```{r, message=FALSE, warning=FALSE}
library(tidyverse)


fertilizer <- read_csv("data/fertilizer.csv") %>%
  clean_names()
```

```{r}
encounters_mi <- encounters %>%
  filter(str_to_lower(description) %in%
           str_to_lower(c("Cardiac Arrest", "Myocardial Infarction"))
         )
encounters_mi
```
:::::

Q: How old was the patient at the time of a "heart attack"?

::::: {.rBlock}
###### R {-}
```{r}
patients <- read_csv("data/synthea/patients.csv") %>%
  clean_names()

patients
```
:::::

## Joins

- `inner_join()`: includes all rows in x and y.

```{r, echo=FALSE}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/3abea0b730526c3f053a3838953c35a0ccbe8980/7f29b/diagrams/join-inner.png")
```

- `left_join()`: includes all rows in x.
- `right_join()`: includes all rows in y.
- `full_join()`: includes all rows in x or y.

For more detailed information about Joins, click here: https://r4ds.had.co.nz/relational-data.html

```{r, echo=FALSE}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/9c12ca9e12ed26a7c5d2aa08e36d2ac4fb593f1e/79980/diagrams/join-outer.png")
```

```{r, echo=FALSE}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/aeab386461820b029b7e7606ccff1286f623bae1/ef0d4/diagrams/join-venn.png")
```


```{r}
encounters_pt <- encounters_mi %>%
  left_join(patients, by = c("patient" = "id"))
encounters_pt
```

### Keep track of the number of rows

```{r, echo=FALSE}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/6faac3e996263827cb57fc5803df6192541a9a4b/c7d74/diagrams/join-one-to-many.png")
```

::::: {.rBlock}
###### R {-}
```{r}
nrow(encounters_mi)
```

```{r}
nrow(patients)
```

```{r}
dim(encounters_pt)
```

```{r}
nrow(encounters_pt)
```
:::::

### Formally test your assumptions

::::: {.rBlock}
###### R {-}
```{r}
stopifnot(nrow(encounters_mi) == nrow(encounters_pt)) # test your work
```

```{r, error=TRUE}
stopifnot(nrow(encounters_mi) == 100) # test your work
```
:::::

```{r, echo=FALSE}
knitr::include_graphics("https://d33wubrfki0l68.cloudfront.net/d37530bbf7749f48c02684013ae72b2996b07e25/37510/diagrams/join-many-to-many.png")
```

### Different types of joins

::::: {.rBlock}
###### R {-}
```{r}
pt_encounters <- patients %>%
  left_join(encounters_mi, by = c("id" = "patient"))
pt_encounters
```

```{r}
inner_join(encounters_mi, patients, by = c("patient" = "id"))
```

```{r}
full_join(encounters_mi, patients, by = c("patient" = "id"))
```
:::::

### Age at time of heart attack

::::: {.rBlock}
###### R {-}
```{r}
library(lubridate)

today()
```

```{r}
current_date = ymd("2020-04-28")
current_date
```
:::::

#### Date arithmetic

::::: {.rBlock}
###### R {-}
```{r}
# age "today"
mi_encounters_pt <- encounters_pt %>%
  select(id, start, stop, patient, description, reasondescription, birthdate, deathdate) %>%
  mutate(age_today_duration = birthdate %--% current_date,
         age_years_today = trunc(as.duration(age_today_duration) / dyears(1))
         )
```

```{r}
# age at event
mi_encounters_pt <- mi_encounters_pt %>%
  mutate(age_event_duration = birthdate %--% start,
         age_years_event = trunc(as.duration(age_event_duration) / dyears(1))
  )
```
:::::

::::: {.rBlock}
###### R {-}
```{r}
library(ggplot2)

ggplot(mi_encounters_pt, aes(x = age_years_event)) +
  geom_histogram(bins = 10)
```

```{r}
ggplot(mi_encounters_pt, aes(x = age_years_event, fill=description)) +
  geom_histogram(bins = 10)
```

```{r}
ggplot(mi_encounters_pt, aes(x = age_years_event)) +
  geom_histogram(bins = 10) +
  facet_wrap(~ description)
```
:::::


## Databases

Learning about databases is an important aspect of data science and analytics. 

For more information on databases and the RSQLite interface, click here: https://cran.r-project.org/web/packages/RSQLite/vignettes/RSQLite.html

::::: {.rBlock}
###### R {-}
```{r}
library(tidyverse)
library(RSQLite)
```
:::::

::::: {.rBlock}
###### R {-}
```{r}
patients <- read_csv("data/synthea/patients.csv")
encounters <- read_csv("data/synthea/encounters.csv")
```

```{r}
patients %>%
  filter(MARITAL == "M") %>%
  select(Id, BIRTHDATE, DEATHDATE, MARITAL) %>%
  head(5)
```
:::::

### Database connection

::::: {.rBlock}
###### R {-}
```{r}
con <- dbConnect(SQLite(), "data/synthea/synthea.sqlite")
dbListTables(con)
```
:::::

### Database tables

::::: {.rBlock}
###### R {-}
```{r}
patients_db <- tbl(con, "patients")

patients_db %>%
  filter(MARITAL == "M") %>%
  select(Id, BIRTHDATE, DEATHDATE, MARITAL) %>%
  head(5)
```
:::::

### SQL

::::: {.rBlock}
###### R {-}
```{r}
dbGetQuery(con, 'SELECT * FROM patients LIMIT 5')
```

```{r}
dbGetQuery(con, 'SELECT Id, BIRTHDATE, DEATHDATE, MARITAL FROM patients WHERE MARITAL = "M" LIMIT 5')
```

#### Pass variables to SQL

```{r}
dbGetQuery(con, 'SELECT Id, BIRTHDATE, DEATHDATE, MARITAL FROM patients WHERE MARITAL = :x LIMIT 5', 
           params = list(x = "M"))
```
:::::

### Show SQL query

::::: {.rBlock}
###### R {-}
```{r}
patients_db %>%
  group_by(MARITAL, RACE, ETHNICITY, GENDER) %>%
  summarize(count = n()) %>%
  arrange(-count)
```
:::::

::::: {.rBlock}
###### R {-}
```{r}
patients_db %>%
  group_by(MARITAL, RACE, ETHNICITY, GENDER) %>%
  summarize(count = n()) %>%
  arrange(-count) %>%
  show_query()
```
:::::

::::: {.rBlock}
###### R {-}
```{r}
dbGetQuery(con,
           "SELECT `MARITAL`, `RACE`, `ETHNICITY`, `GENDER`, COUNT(*) AS `count`
FROM `patients`
GROUP BY `MARITAL`, `RACE`, `ETHNICITY`, `GENDER`
ORDER BY -`count`")
```
:::::
