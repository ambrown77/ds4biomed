
# Analysis Intro

An introduction to analysis.

Learning how to read output.

## Logistic Regression

```{r, echo=TRUE, message=FALSE}
library(medicaldata)
library(tidyverse)
```

```{r}
blood <- blood_storage
```


Variable of interest: `Recurrence`. It is a binary variable that only has 2 possible values.

```{r}
blood %>%
  group_by(Recurrence) %>%
  summarize(count = n())
```

Logistic regression is linear regression using the logit function as a transformation.

$\text{logit}(p) = log(\frac{p}{1 - p})$

Since it is a form of a linear regression, it is known as a **generalized linear regression** method (GLM).
We can use the `glm` function in R.

### Model 1

```{r}
mod1 <- glm(Recurrence ~ Age, data = blood, family = "binomial")
```

```{r}
mod1
```

```{r}
summary(mod1)
```

```{r}
library(broom)
```

```{r}
res1 <- tidy(mod1)
res1
```

Whatever we do after fitting the model, we have to undo the logit function for interpretation.
Otherwise all the values have to be interpreted as "log-odds" which is not intutitive.

However, "odds" is intuitive, so we only really need to undo the "log".
We do this by exponentiation.

```{r}
res1 %>%
  mutate(odds = exp(estimate))
```

For every 1 unit increase in `Age`, the **odds** of going from 0 to 1 in our response increases by 1.02 times.
That is, the **odds** of earlier biochemical recurrence of prostate cancer after prostatectomy increases by 1.02 times for every unit increase in age.

### Model 2

- `PVol`: Prostate volumn in grams (g)
- `PreopPSA`: Preoperative prostate specification antigen (PSA) in ng/mL

```{r}
mod2 <- glm(Recurrence ~ Age + PVol + PreopPSA, data = blood, family = "binomial")
summary(mod2)
```

```{r}
mod2 %>%
  tidy() %>%
  mutate(odds = exp(estimate))
```

That is, the **odds** of earlier biochemical recurrence of prostate cancer after prostatectomy increases by 1.10 times for every unit increase in `PreopPSA`, all else equal.

```{r}
ggplot(blood, aes(x = PreopPSA)) +
  geom_histogram()
```

### Model 3


- `TVol` Tumor volume
  - 1 = Low
  - 2 = Medium
  - 3 = Extensive

```{r}
mod3 <- glm(Recurrence ~ Age + PVol + PreopPSA + TVol, data = blood, family = "binomial")
summary(mod3)
```

How do you interpret "one unit increase in `Tvol` (Tumor volume), it is a categorical variable.
It's "ordinal" so you may be able to get away with the interpretation,
but there is no way the value can be `1.5`.

How do we handle categorical variables? We use `as.factor`.

```{r}
mod3_factor <- glm(Recurrence ~ Age + PVol + PreopPSA + as.factor(TVol), data = blood, family = "binomial")
summary(mod3_factor)
```

Notice one of the factors was dropped, this is called the reference variable.
We converted our categorical variable into a set of **dummy variables** (aka one-hot encoding).

```{r}
model.matrix(mod3_factor) %>%
  head()
```

```{r}
mod3_factor %>%
  tidy() %>%
  mutate(odds = exp(estimate))
```

That is, the **odds** of earlier biochemical recurrence of prostate cancer after prostatectomy increases by 22.6 times when the patient has a `TVol` (tumor volume) of "Extensive" when compared to "Low".
All else equal.

```{r}
# save the above table
mod_3_or_table <- mod3_factor %>%
  tidy() %>%
  mutate(odds = exp(estimate))
```


```{r}
#plot the coefficients
ggplot(data = mod_3_or_table, aes(x = term, y = odds)) +
  geom_point() +
  geom_hline(yintercept = 1) +
  coord_flip()
```

```{r}
# add in confidence intervals
ci <- confint(mod3_factor, level = 0.95) %>%
  as.data.frame()
ci

exp(ci)

mod3_or_ci <- mod_3_or_table %>%
  mutate(ci_lower = exp(estimate - (1.96 * std.error)),
         ci_upper = exp(estimate + (1.96 * std.error)))
```

```{r}
ggplot(mod3_or_ci) +
  geom_point(aes(x = term, y = odds)) +
  geom_errorbar(aes(x = term, ymin = ci_lower, ymax = ci_upper)) +
  coord_flip()
```


$y = mx + b$

$y = \text{intercept} + \beta_1x_1 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 + e + \beta_5x_5 + e$

- $\beta_1$: `Age`
- $\beta_2$: `PVol`
- $\beta_3$: `PreopPSA`
- $\beta_4$: `TVol2`
- $\beta_5$: `TVol3`

$\hat{y} = \text{intercept} + \beta_1x_1 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 + \beta_5x_5$

$log(\frac{p}{1 - p}) = \text{intercept} + \beta_1x_1 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 + \beta_5x_5)$
$\frac{p}{1 - p} = odds = e^{(\text{intercept} + \beta_1x_1 + \beta_2x_2 + \beta_3x_3 + \beta_4x_4 + \beta_5x_5)}$

$\beta = log(OR) \leftrightarrow e^{\beta} = OR$


<button class="accordion" id="question">Exercise 1 Question</button>
:::{.panel-question}
1. Load the cytomegalovirus dataset from the `medicaldata` library,
assign it to the variable `cmv`

```{r, eval=FALSE}
library(tidyverse)
library(medicaldata)
____
```

2. Fit a model using the `cmv` dataframe, and the `cmv` variable as the reponse variable.
Save the model to the variable, `mod`

```{r, eval=FALSE}
mod <- glm(____, data = ____,  family = "binomial")
```

3. Use the `summary` function to look at the model output

```{r, eval=FALSE}
ggplot(____, aes(as.factor(____))) +
  geom_bar(aes(fill = as.factor(____)))
```

4. Use the `tidy` function from the `broom` package to get just the coefficients table.
Save this table to the variable `betas`

```{r, eval=FALSE}
library(broom)
____ <- ____(____)
```

5. Convert the `estimate` column into an `or` column using the `mutate` function and exponentiating the column values with the `exp` function.

```{r, eval=FALSE}
betas %>%
  ____(____ = ____(____))
```

6. Interpret one of your ORs
:::

<button class="accordion" id="solution">Exercise 1 Solution</button>
:::{.panel-solution}
```{r}
library(medicaldata)
cmv <- cytomegalovirus

mod <- glm(cmv ~ as.factor(diagnosis) + time.to.transplant + as.factor(recipient.cmv) + as.factor(donor.cmv),
           data = cmv,
           family = "binomial")

summary(mod)

library(broom)
betas <- mod %>%
  tidy()
betas

betas %>%
  mutate(or = exp(estimate))
```
:::
